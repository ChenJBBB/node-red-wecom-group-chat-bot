<script type="text/html" data-template-name="wecom-text">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="节点名称">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-cog"></i> 机器人配置</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-msgType"><i class="fa fa-comment"></i> 消息类型</label>
        <select id="node-input-msgType">
            <option value="text">文本消息</option>
            <option value="markdown">Markdown</option>
            <option value="markdown_v2">Markdown V2</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-mentionedList"><i class="fa fa-at"></i> 提醒userid</label>
        <input type="text" id="node-input-mentionedList" placeholder="提醒的成员userid,多个用逗号分隔, 留空由mentioned_list输入">
    </div>
    <div class="form-row">
        <label for="node-input-mentionedMobileList"><i class="fa fa-mobile"></i> 提醒手机</label>
        <input type="text" id="node-input-mentionedMobileList" placeholder="提醒的成员手机号,多个用逗号分隔，留空由mentioned_mobile_list输入">
    </div>
</script>

<script type="text/html" data-help-name="wecom-text">
    <p>企业微信文本消息节点</p>
    <ul>
        <li><b>名称</b>：节点名称</li>
        <li><b>机器人配置</b>：选择企业微信机器人配置节点</li>
        <li><b>消息类型</b>：选择要发送的消息类型
            <ul>
                <li>文本消息：支持发送普通文本，可以@群成员</li>
                <li>Markdown：支持发送 Markdown 格式的消息</li>
                <li>Markdown V2：支持发送 Markdown V2 格式的消息，提供更丰富的格式选项</li>
            </ul>
        </li>
        <li><b>提醒userid</b>：要提醒的用户ID列表，用逗号分隔（仅文本消息类型可用）</li>
        <li><b>提醒手机</b>：要提醒的手机号列表，用逗号分隔（仅文本消息类型可用）</li>
    </ul>
    
    <h3>输入</h3>
    <ul>
        <li><b>msg.payload</b>：要发送的消息内容（必需）</li>
        <li><b>msg.msgType</b>：动态覆盖配置的消息类型（可选，支持：text、markdown、markdown_v2）</li>
        <li><b>msg.mentioned_list</b>：动态提醒的用户ID列表（可选，仅文本消息类型有效）</li>
        <li><b>msg.mentioned_mobile_list</b>：动态提醒的手机号列表（可选，仅文本消息类型有效）</li>
    </ul>
    
    <h3>输出</h3>
    <ul>
        <li>成功时：输出原始消息</li>
        <li>失败时：输出包含错误信息的消息
            <ul>
                <li>msg.payload.error：true 表示发生错误</li>
                <li>msg.payload.message：错误信息</li>
                <li>msg.payload.originalPayload：原始消息内容</li>
            </ul>
        </li>
    </ul>
    
    <h3>注意事项</h3>
    <ul>
        <li>提醒功能（@群成员）仅在文本消息类型下可用</li>
        <li>Markdown 和 Markdown V2 类型不支持提醒功能</li>
        <li>可以通过 msg.msgType 动态覆盖配置的消息类型</li>
        <li>如果提醒列表留空，将使用前一个节点的 msg.mentioned_list 和 msg.mentioned_mobile_list</li>
        <li>即使发送失败，节点也会继续输出消息流，错误信息会包含在 payload 中</li>
    </ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('wecom-text', {
        category: '企业微信',
        color: '#27B4F1',
        defaults: {
            name: { value: "" },
            server: { value: "", type: "wecom-config", required: true },
            msgType: { value: "text" },
            mentionedList: { value: "" },
            mentionedMobileList: { value: "" }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-commenting-o",
        label: function() {
            return this.name || "企业微信文本";
        },
        oneditprepare: function() {
            // 初始化时检查消息类型
            var msgType = $("#node-input-msgType").val();
            if (msgType !== 'text') {
                $("#node-input-mentionedList").closest('.form-row').hide();
                $("#node-input-mentionedMobileList").closest('.form-row').hide();
            }
            
            // 监听消息类型变化
            $("#node-input-msgType").change(function() {
                var selectedType = $(this).val();
                if (selectedType === 'text') {
                    $("#node-input-mentionedList").closest('.form-row').show();
                    $("#node-input-mentionedMobileList").closest('.form-row').show();
                } else {
                    $("#node-input-mentionedList").closest('.form-row').hide();
                    $("#node-input-mentionedMobileList").closest('.form-row').hide();
                }
            });
        }
    });
</script> 